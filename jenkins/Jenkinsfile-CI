pipeline {
    agent { label 'lab' }

    environment {
        REGISTRY = "hieutv.registry.com"
    }

    stages {

        stage('Get Git Commit Hash') {
            steps {
                script {
                    IMAGE_TAG = sh(
                        script: "git rev-parse --short HEAD",
                        returnStdout: true
                    ).trim()

                    echo "Using IMAGE_TAG (git commit): ${IMAGE_TAG}"
                }
            }
        }

        stage('Read Services Config') {
            steps {
                script {
                    services = readJSON file: 'services.json'
                    echo "Loaded services: ${services*.name}"
                }
            }
        }

        stage('Build & Push Docker Images') {
            steps {
                script {
                    def buildStages = [:]

                    for (s in services) {
                        def service = s
                        buildStages[service.name] = {
                            sh """
                            echo "Building image for ${service.name}"
                            echo "Image tag: ${IMAGE_TAG}"
                            docker build -t ${REGISTRY}/${service.name}:${IMAGE_TAG} ${service.dockerPath}
                            docker push ${REGISTRY}/${service.name}:${IMAGE_TAG}
                            """
                        }
                    }

                    parallel buildStages
                }
            }
        }
    }

    post {
        success {
            echo "CI pipeline finished successfully for all services!"
            echo "Image tag used: ${IMAGE_TAG}"
        }
        failure {
            echo "CI pipeline failed!"
        }
    }
}
